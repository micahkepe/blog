<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- Enable responsiveness on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
      
        
        <meta name="description" content="Hacked by an image? How could that be possible? This is the story of how a
seemingly innocuous image format, WebP, was discovered to have a critical
vulnerability that could be exploited to execute arbitrary code on a victim&#x27;s
machine." />
        <meta property="og:description" content="Hacked by an image? How could that be possible? This is the story of how a
seemingly innocuous image format, WebP, was discovered to have a critical
vulnerability that could be exploited to execute arbitrary code on a victim&#x27;s
machine." />
        <meta property="twitter:description" content="Hacked by an image? How could that be possible? This is the story of how a
seemingly innocuous image format, WebP, was discovered to have a critical
vulnerability that could be exploited to execute arbitrary code on a victim&#x27;s
machine." />
      
    

    <!-- Title -->
    
      
    
    <title>
    
    WebP: A Case Study in the Hidden Vulnerabilities of Image Formats
    
</title>

    <!-- Additional Facebook Meta Tags -->
    <meta property="og:site_name" content="Micah&#x27;s Secret Blog" />
    <meta
      property="og:url"
      content="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog&#x2F;webp-vulnerability&#x2F;"
    />
    <meta
      property="og:type"
      content="article"
    />
    <meta property="og:title" content="WebP: A Case Study in the Hidden Vulnerabilities of Image Formats" />

    <!-- Additional Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      property="twitter:url"
      content="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog&#x2F;webp-vulnerability&#x2F;"
    />
    <meta name="twitter:title" content="WebP: A Case Study in the Hidden Vulnerabilities of Image Formats" />

    <!-- Additional Fediverse Tags -->
     

    <!-- Cover images -->
    
    

    <meta
      property="og:image"
      content="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog&#x2F;icons&#x2F;favicon&#x2F;web-app-manifest-512x512.png"
    />

    <meta
      name="twitter:image"
      content="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog&#x2F;icons&#x2F;favicon&#x2F;web-app-manifest-512x512.png"
    />



    <!-- Favicons -->
    
    <link
      rel="icon"
      type="image/png"
      href="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog/icons/favicon/favicon-96x96.png"
      sizes="96x96"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog/icons/favicon/favicon.svg"
    />
    <link
      rel="shortcut icon"
      href="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog/icons/favicon/favicon.ico"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog/icons/favicon/apple-touch-icon.png"
    />
    <meta name="apple-mobile-web-app-title" content="WebP: A Case Study in the Hidden Vulnerabilities of Image Formats" />
    <link
      rel="manifest"
      href="https:&#x2F;&#x2F;micahkepe.com&#x2F;blog/icons/favicon/site.webmanifest"
    />
    

    <!-- RSS Feed -->
    
    <link
      rel="alternate"
      type="application/atom+xml"
      title="RSS"
      href="https://micahkepe.com/blog/atom.xml"
    />
    

    <!-- Load Styles -->
    


      <link
        rel="stylesheet"
        href="https://micahkepe.com/blog/site.css"
      />
    

<!-- Custom styling -->
<link
  rel="stylesheet"
  href="https://micahkepe.com/blog/custom.css"
/>



    <!-- Load Fonts -->
    

  






  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  



<!-- Forcing Font -->
<style>
body {
  font-family:
    "JetBrains Mono", Menlo, Monaco, Lucida Console, Liberation Mono,
    DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New,
    monospace, serif !important;
}
</style>


    <!-- Pass Theme Preference as Data Attribute -->
    <script src="https://micahkepe.com/blog/js/init-theme.js"></script>

    <!-- Reference return to click position script -->
    <script defer src="https://micahkepe.com/blog/js/reference-return.js"></script>

    <!-- Additional scripts -->
    
      
        <script defer src="https://micahkepe.com/blog/js/codeblock.js"></script>
      
      
        <script src="https://micahkepe.com/blog/js/toggle-theme.js"></script>
      
      
<!-- MathJax script for rendering LaTeX math equations -->
<script src="https://micahkepe.com/blog/js/mathjax-config.js"></script>
<script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
  async
></script>


      
<script type="text/javascript" src="https://micahkepe.com/blog/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://micahkepe.com/blog/js/search.js"></script>

    
  </head>

  <!-- Body element (contents of the page) -->
  <body class="hack main container">
    

  
    
    
      
  
  <section class="nav-header">
    <nav
      itemscope
      itemtype="http://schema.org/SiteNavigationElement"
      class="navbar"
    >
      <section class="nav-links">
        
        <a
          itemprop="url"
          class=""
          href="https://micahkepe.com/blog/"
        >
          <span itemprop="name">Home</span>
        </a>
        
        <a
          itemprop="url"
          class=""
          href="https://micahkepe.com/blog/categories"
        >
          <span itemprop="name">Categories</span>
        </a>
        
        <a
          itemprop="url"
          class=""
          href="https://micahkepe.com/blog/tags"
        >
          <span itemprop="name">Tags</span>
        </a>
        
        <a
          itemprop="url"
          class=""
          href="https://micahkepe.com/"
        >
          <span itemprop="name">Main Site</span>
        </a>
        
      </section>
    </nav>
    <aside class="user-actions-container">
      
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        class="search-icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
        />
      </svg>
      <input type="text" id="search" placeholder="Search..." />
      <section class="search-results" aria-live="polite">
        <article class="search-results__items" role="list"></article>
      </section>
       
      <a id="dark-mode-toggle" href="#">
        <img
          src="https://micahkepe.com/blog/icons/sun.svg"
          id="sun-icon"
          style="filter: invert(1)"
          alt="Light mode"
        />
        <img
          src="https://micahkepe.com/blog/icons/moon.svg"
          id="moon-icon"
          alt="Dark mode"
        />
      </a>
       
      <a
        href="https://micahkepe.com/blog/atom.xml"
        class="feed-icon"
        rel="noopener noreferrer"
      >
        <img
          src="https://micahkepe.com/blog/icons/rss.svg"
          id="rss-icon"
          alt="RSS feed"
          class="social-icon"
        />
      </a>
       
      <a
        href="https:&#x2F;&#x2F;github.com&#x2F;micahkepe"
        class="feed-icon"
        rel="noopener noreferrer"
      >
        <img
          src="https://micahkepe.com/blog/icons/github.svg"
          id="github-icon"
          alt="GitHub"
          class="social-icon"
        />
      </a>
       
    </aside>
  </section>
  

    


    <main>
      

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">WebP: A Case Study in the Hidden Vulnerabilities of Image Formats</h1>
        <data class="muted">
    <svg class="icon i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <data>8 minute read</data>
    <svg class="icon i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2024-05-13
</data>
    </header>

    <article itemprop="articleBody">
        
            <p>Hacked by an image? How could that be possible? This is the story of how a
seemingly innocuous image format, WebP, was discovered to have a critical
vulnerability that could be exploited to execute arbitrary code on a victim's
machine.</p>

            
              <details class="toc-container">
  <summary class="toc-title">Table of Contents</summary>
  <ul class="toc-list">
    
    <li>
      <a href="https://micahkepe.com/blog/webp-vulnerability/#understanding-image-formats-and-background-on-webp">Understanding Image Formats and Background on WebP</a>
      
    </li>
    
    <li>
      <a href="https://micahkepe.com/blog/webp-vulnerability/#the-complexity-of-huffman-encoding-and-decoding">The Complexity of Huffman Encoding and Decoding</a>
      
    </li>
    
    <li>
      <a href="https://micahkepe.com/blog/webp-vulnerability/#the-webp-vulnerability-cve-2023-4863">The WebP Vulnerability (CVE-2023-4863)</a>
      
    </li>
    
    <li>
      <a href="https://micahkepe.com/blog/webp-vulnerability/#how-was-this-not-caught-earlier">How Was This Not Caught Earlier?</a>
      
    </li>
    
    <li>
      <a href="https://micahkepe.com/blog/webp-vulnerability/#conclusion">Conclusion</a>
      
    </li>
    
    <li>
      <a href="https://micahkepe.com/blog/webp-vulnerability/#references">References</a>
      
    </li>
    
  </ul>
</details>

            

            <!-- Render the rest of the content after removing the summary portion -->
            
<span id="continue-reading"></span><h2 id="understanding-image-formats-and-background-on-webp"><a class="zola-anchor" href="#understanding-image-formats-and-background-on-webp" aria-label="Anchor link for: understanding-image-formats-and-background-on-webp">Understanding Image Formats and Background on WebP</a></h2>
<p>Under the hood, images are just binary data that represent pixels on a screen.
Different image formats encode this data in various ways, each with its own
strengths and weaknesses. Some formats, like JPEG and PNG, are well-known and
widely used. Others, like Google's WebP format, are newer and less common but
offer advantages such as better compression and transparency support. When a
user opens any picture, the picture has to be rendered on the screen by the
computer by decoding the binary data contained in the image file. This decoding
process is handled by an image decoder, which reads the image data, interprets
it, and displays the image on the screen. The decoder must understand the
specific format of the image file to perform this task correctly.</p>
<section
  style="width: 100%; max-width: 70%; margin: 0 auto; text-align: center;">
  <img src="image-encode-decode.png"  alt="JPEG Image Decoding Process" 
    style="max-width: 100%; height: auto; display: inline-block;">
  
  <caption style="margin-top: 0.5em;">
    <p style="font-style: italic;">Above: The process of encoding and decoding a JPEG image.</p>
  </caption>
  
</section>
<p>You'll often hear about image formats being "lossy" or "lossless." Lossy
formats, like JPEG, discard some image data to achieve higher compression
ratios, while lossless formats, like PNG, preserve all the original data. WebP
is unique in that it can be both lossy and lossless, depending on the settings
used during encoding. This flexibility makes it a popular choice for web
developers looking to balance image quality and file size.</p>
<p>The <code>libwebp</code> is a popular open-source library that is used to encode and decode
WebP images. It is widely used in web browsers, image editing software, and
other applications that support the WebP format. The library provides functions
for reading and writing WebP images, as well as encoding and decoding the pixel
data. The vulnerability in WebP that we will discuss later is related to the
lossless encoding and decoding process used by the <code>libwebp</code> library.</p>
<h2 id="the-complexity-of-huffman-encoding-and-decoding"><a class="zola-anchor" href="#the-complexity-of-huffman-encoding-and-decoding" aria-label="Anchor link for: the-complexity-of-huffman-encoding-and-decoding">The Complexity of Huffman Encoding and Decoding</a></h2>
<p>WebP's lossless variant is based on a technique called Huffman encoding, which
is used to compress data by assigning shorter codes to more frequent symbols.
This process involves building a binary tree where each symbol corresponds to a
unique path from the root to a leaf node. The tree is then used to encode and
decode the data efficiently.</p>
<p>To illustrate this concept, consider a simple example where we have four symbols
(A, B, C, and D) whose frequencies are as follows:</p>
<ul>
<li>A: 50%</li>
<li>B: 25%</li>
<li>C: 15%</li>
<li>D: 10%</li>
</ul>
<p>The Huffman tree for these symbols might look like this:</p>
<pre style="width: 40%; margin: 0 auto;">
   root
  /    \
 A      root
       /    \
      B      root
            /    \
           C      D
</pre>
<p>In this tree, the symbol A is encoded as <code>0</code>, B as <code>10</code>, C as <code>110</code>, and D as
<code>111</code>. When encoding a sequence of symbols, we traverse the tree from the root
to the leaf node corresponding to each symbol, generating a binary code along
the way. This process ensures that more frequent symbols are assigned shorter
codes, reducing the overall size of the encoded data.</p>
<p>Huffman tables are used to store the mapping between symbols and their
corresponding codes. These tables are typically constructed during the encoding
process and are required for decoding the data. For the example above, the
Huffman table might look like this:</p>
<table><thead><tr><th><strong>Symbol</strong></th><th><strong>Code</strong></th></tr></thead><tbody>
<tr><td>A</td><td>0</td></tr>
<tr><td>B</td><td>10</td></tr>
<tr><td>C</td><td>110</td></tr>
<tr><td>D</td><td>111</td></tr>
</tbody></table>
<p>As you can see, the most frequent symbol (A) is assigned the shortest code,
while the least frequent symbol (D) is assigned the longest code. This property
of Huffman encoding helps achieve efficient compression by reducing the average
code length. Huffman tables effectively capture the structure of the Huffman
tree, with one table per alphabet size (number of symbols) used in the encoding
process.</p>
<p>In the case of WebP, the Huffman tree is stored in the image file along with the
encoded pixel data. When the image is decoded, the tree is reconstructed, and
the pixel data is decoded using the tree's structure.</p>
<h2 id="the-webp-vulnerability-cve-2023-4863"><a class="zola-anchor" href="#the-webp-vulnerability-cve-2023-4863" aria-label="Anchor link for: the-webp-vulnerability-cve-2023-4863">The WebP Vulnerability (CVE-2023-4863)</a></h2>
<p>In September 2023, a critical vulnerability was discovered in the WebP image
format that allowed attackers to execute arbitrary code on a victim's machine.
The vulnerability, assigned CVE-2023-4863, was caused by a heap buffer overflow
in the Huffman decoding process. By crafting a specially designed WebP image, an
attacker could trigger the overflow and overwrite memory in the decoder, leading
to a variety of potential exploits.</p>
<p>But triggering the vulnerability is not as simple as sending a malicious image
file to a victim. The attacker must carefully construct the image to exploit the
specific conditions that trigger the heap buffer overflow. This requires a deep
understanding of the WebP format and the internal workings of the decoder,
making it a non-trivial task even for experienced security researchers.</p>
<p>Ben Hawkes, the Project Zero team lead at Google, described the following steps
to trigger the vulnerability:</p>
<ol>
<li>
<p>Construct a sequence of 4 valid Huffman tables that are maximally sized for
two different alphabet sizes (280 and 256).</p>
</li>
<li>
<p>Next, construct a very specific type of invalid Huffman table for a third
alphabet size (40).</p>
</li>
<li>
<p>Finally, the vulnerability will be manifested in the <code>BuildHuffmanTable</code>
function in the <code>libwebp</code> library when the invalid Huffman table is
processed. The issue is that there was no length check on the buffer that was
allocated for the Huffman table, which could lead to an out-of-bounds write
when the invalid table is unpacked by the decoder. This means the function
could be coerced into writing data beyond the allocated buffer, leading to an
out-of-bounds write and potential memory corruption. The overflow will lead
to a double-free vulnerability, which can be exploited to execute arbitrary
code.</p>
</li>
</ol>
<p>If any of the above steps are not followed correctly, the vulnerability will not
be triggered and the image decoder will simply throw an error. Practically, this
means that exploiting the vulnerability requires a high level of expertise and
knowledge of the WebP format, making it unlikely to be used in widespread
attacks.</p>
<p><a href="https://github.com/mistymntncop">mistymntncop</a>, a security researcher, created
a proof-of-concept exploit for the WebP vulnerability, and produced this
visualization of the unbalanced Huffman table the is constructed from the
crafted WebP image:</p>
<section
  style="width: 100%; max-width: 90%; margin: 0 auto; text-align: center;">
  <img src="invalid-tree.png"  alt="Invalid Huffman Tree" 
    style="max-width: 100%; height: auto; display: inline-block;">
  
  <caption style="margin-top: 0.5em;">
    <p style="font-style: italic;">Above: An unbalanced Huffman tree created
from a crafted WebP image.</p>
  </caption>
  
</section>
<p>In contrast, here is the visualization balanced Huffman tree created from a
valid WebP image:</p>
<section
  style="width: 100%; max-width: 90%; margin: 0 auto; text-align: center;">
  <img src="valid-tree.png"  alt="Valid Huffman Tree" 
    style="max-width: 100%; height: auto; display: inline-block;">
  
  <caption style="margin-top: 0.5em;">
    <p style="font-style: italic;">Above: A balanced Huffman tree created
from a valid WebP image.</p>
  </caption>
  
</section>
<h2 id="how-was-this-not-caught-earlier"><a class="zola-anchor" href="#how-was-this-not-caught-earlier" aria-label="Anchor link for: how-was-this-not-caught-earlier">How Was This Not Caught Earlier?</a></h2>
<p>Even though there are many fuzzing tools and techniques available to detect
vulnerabilities in software, the reason this bug was not caught earlier is
mostly due to the sheer complexity and specificity of the conditions required to
trigger it. As Hawkes mentions in his zero-day disclosure, "[o]ut of billions
of possibilities," only a 4 table sequence of a specific size and an invalid
table of a specific size will trigger the vulnerability.</p>
<p>To see for yourself how complex the conditions are, you can check out the nearly
<strong>600-line</strong> C code that was used to trigger the vulnerability
<a href="https://github.com/mistymntncop/CVE-2023-4863/blob/main/craft.c">here</a>.</p>
<h2 id="conclusion"><a class="zola-anchor" href="#conclusion" aria-label="Anchor link for: conclusion">Conclusion</a></h2>
<p>This vulnerability has since been patched, so if you're using the most recent
versions of your browsers than you can rest easy that you're not susceptible to
this attack. However, the WebP vulnerability serves as a reminder that security
vulnerabilities can lurk in unexpected places, even in seemingly benign image
formats. As software systems become more complex and interconnected, it is
essential to conduct thorough security assessments of all components, including
image decoders and parsers. By identifying and addressing vulnerabilities
proactively, we can help prevent potential exploits and protect users from
malicious attacks.</p>
<h2 id="references"><a class="zola-anchor" href="#references" aria-label="Anchor link for: references">References</a></h2>
<ul>
<li><a href="https://www.researchgate.net/profile/Borko-Furht/publication/229038449/figure/fig4/AS:667829439311887@1536234354786/Block-diagram-of-sequential-JPEG-encoder-and-decoder-JPEG-Encoder-The-original-samples.png">JPEG Image Encoding and Decoding Figure</a></li>
<li><a href="https://blog.cloudflare.com/uncovering-the-hidden-webp-vulnerability-cve-2023-4863">Uncovering the Hidden WebP vulnerability: a tale of a CVE with much bigger implications than it originally seemed</a></li>
<li><a href="https://www.cvedetails.com/cve/CVE-2023-4863">CVE-2023-4863 Detail</a></li>
<li><a href="https://prisminfosec.com/webps-weak-spot-unveiling-the-hidden-vulnerability/#:~:text=Last%20month%20(September%202023)%2C,under%20CVE%2D2023%2D4863.">WEBP’S WEAK SPOT: UNVEILING THE HIDDEN VULNERABILITY</a></li>
<li><a href="https://blog.isosceles.com/the-webp-0day/">The WebP 0day</a></li>
<li><a href="https://www.youtube.com/watch?v=89ysXVYH2Sk">Explanation from the Youtube channel Low Level Learning</a></li>
<li><a href="https://github.com/mistymntncop/CVE-2023-4863/tree/main">Proof-of-Concept for CVE-2023-4863 by Hawkes and mistymntncop</a></li>
</ul>


        
    </article>

    <!-- Comment section -->
    
      
        
          <script
  src="https://giscus.app/client.js"
  data-repo="micahkepe&#x2F;blog"
  data-repo-id="R_kgDONfHznQ"
  data-category="General"
  data-category-id="DIC_kwDONfHznc4CnQJ4"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"

  
  data-theme="preferred_color_scheme"
  

  data-lang="en"
  data-loading="lazy"
  crossorigin="anonymous"
  async
></script>

        
      
    


    <!-- Page footer -->
    
    <footer>
        <hr>
        <p>
            
                Published by Micah Kepe
            
            
                
                in <a href="https://micahkepe.com/blog/categories/theory/">theory</a>
            
            
                and
                tagged
                
                    <a href="https://micahkepe.com/blog/tags/infosec/">infosec</a>
                    
                        
                            
                                ,
                            
                        
                    
                
                    <a href="https://micahkepe.com/blog/tags/webp/">webp</a>
                    
                        
                            
                                and
                            
                        
                    
                
                    <a href="https://micahkepe.com/blog/tags/vulnerability/">vulnerability</a>
                    
                        
                    
                
            
        </p>

        <!-- Revision history (optional) -->
        
          
            
              
                
                
                <section class="revision-history">
                  <a href="https:&#x2F;&#x2F;github.com&#x2F;micahkepe&#x2F;blog&#x2F;commits&#x2F;main&#x2F;content&#x2F;webp-vulnerability&#x2F;index.md" target="_blank" rel="noopener noreferrer">
                    (revision history)
                  </a>
                </section>
              
            
          
        

        
        
    </footer>


</article>


    </main>
    





  </body>
</html>
